---
# https://docs.linuxserver.io/images/docker-jellyfin

- set_fact:  # noqa 502
    _name: jellyfin
    _volumes:
      - [ '/config', '/config', 'rw' ]
      - [ '/vc', '/opt/vc/lib', 'rw' ]
      - '{{ unraid.tls_storage_dir }}:/tls:ro'

- include_tasks: '{{ playbook_dir }}/dry/docker/unraid-container.yml'
  vars:
    name: '{{ _name }}'
    image: lscr.io/linuxserver/jellyfin:latest
    webui: 'https://{{ _name }}.{{ lab_domain_name }}/web/index.html'
    env:
      JELLYFIN_PublishedServerUrl: '{{ _name }}.{{ lab_domain_name }}'
    networks:
      - name: '{{ docker_config.network.iot.name }}'  # IOT net, due to DLNA
        ipv4_address: '{{ services.jellyfin.static_ip }}'
      - name: '{{ docker_config.network.external.name }}'
    volumes: '{{ _volumes|list + services.jellyfin.media_volumes_mapping|list }}'

    extra:
      cpus: 4
      memory: 5G
      kernel_memory: 7G

      # Remove healthcheck from container
      healthcheck:
        test: [ "NONE" ]
      # https://www.youtube.com/watch?v=S4fcR4s15OI
      mounts:
        - type: tmpfs
          target: /tmp
          tmpfs_size: 10737418240  # 20 GB


- name: Allow non-root user to bind to tcp port < 1024  # https://unix.stackexchange.com/a/10737
  include_tasks: '{{ playbook_dir }}/dry/docker/exec.yml'
  vars:
    container_name: '{{ _name }}'
    commit: true
    commands:
      - apt-get update
      - apt-get install -y --no-upgrade --no-install-recommends libcap2-bin
      - setcap cap_net_bind_service=ep /usr/lib/jellyfin/bin/jellyfin
